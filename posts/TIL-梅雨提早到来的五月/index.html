<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Ckitakishi"/><link rel="canonical" href="ckitakishi.com/posts/TIL-%E6%A2%85%E9%9B%A8%E6%8F%90%E6%97%A9%E5%88%B0%E6%9D%A5%E7%9A%84%E4%BA%94%E6%9C%88"/><meta name="twitter:url" content="ckitakishi.com/posts/TIL-%E6%A2%85%E9%9B%A8%E6%8F%90%E6%97%A9%E5%88%B0%E6%9D%A5%E7%9A%84%E4%BA%94%E6%9C%88"/><meta name="og:url" content="ckitakishi.com/posts/TIL-%E6%A2%85%E9%9B%A8%E6%8F%90%E6%97%A9%E5%88%B0%E6%9D%A5%E7%9A%84%E4%BA%94%E6%9C%88"/><title>[TIL] 梅雨提早到來的五月 | Ckitakishi</title><meta name="twitter:title" content="[TIL] 梅雨提早到來的五月 | Ckitakishi"/><meta name="og:title" content="[TIL] 梅雨提早到來的五月 | Ckitakishi"/><meta name="description" content="五月主题：byWordWrapping - 孤独的单词，fileSystemRepresentation, stat - st_size 是什么类型, lineHeight and lineSpacing..."/><meta name="twitter:description" content="五月主题：byWordWrapping - 孤独的单词，fileSystemRepresentation, stat - st_size 是什么类型, lineHeight and lineSpacing..."/><meta name="og:description" content="五月主题：byWordWrapping - 孤独的单词，fileSystemRepresentation, stat - st_size 是什么类型, lineHeight and lineSpacing..."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Ckitakishi"/></head><body class="item-page"><div class="flex flex-col min-h-full text-zinc-900 dark:text-zinc-50"><div class="grid grid-cols-8 w-full h-[8px]"><div class="bg-[#ab4642]"></div><div class="bg-[#dc9656]"></div><div class="bg-[#f7ca88]"></div><div class="bg-[#a1b56c]"></div><div class="bg-[#86c1b9]"></div><div class="bg-[#7cafc2]"></div><div class="bg-[#ba8baf]"></div><div class="bg-[#a16946]"></div></div><header class="flex justify-center p-4 text-zinc-900 dark:text-zinc-50"><div class="flex flex-wrap justify-between my-4 gap-x-16 max-w-screen-lg w-full"><a href="/" class="header-title font-extrabold text-3xl">Ckitakishi</a><nav class="my-auto"><ul class="flex flex-wrap gap-4"><li><a href="/" class="hover:underline underline-offset-4">Home</a></li><li><a href="/posts" class="hover:underline underline-offset-4">Writing</a></li><li><a href="/tags/求索集/" class="hover:underline underline-offset-4">求索集</a></li><li><a href="/tags/浮生记/" class="hover:underline underline-offset-4">浮生记</a></li><li><a href="/feed.rss" class="hover:underline underline-offset-4">RSS</a></li></ul></nav></div></header><div class="flex justify-center mx-4"><div class="max-w-screen-md w-full m-4"><div class="flex text-zinc-600 dark:text-zinc-50 mb-1"><p class="flex shrink-0">Jun 1, 2021</p><p class="mx-3 text-lg -mt-0.5">|</p><ul class="flex flex-wrap gap-2"><li><a href="/tags/求索集" class="hashtag link-underline">求索集</a></li><li><a href="/tags/ios" class="hashtag link-underline">iOS</a></li><li><a href="/tags/swift" class="hashtag link-underline">Swift</a></li><li><a href="/tags/til" class="hashtag link-underline">TIL</a></li></ul></div><article class="prose prose-zinc min-w-full dark:prose-invert"><div class="content"><h1>[TIL] 梅雨提早到來的五月</h1><p>记录日常开发中遇到的</p><ol><li>新知</li><li>对旧知识的新认知</li><li>重新唤起的记忆</li><li>review 中遇到的一些有趣的问题</li></ol><h1>05/30</h1><h2>byWordWrapping - 孤独的单词</h2><p>有一段类似下面这样的代码，和一个字符串 “This message could not be delivered”，假设 label 的宽度正好会导致字符串在 delivered 前被截断。</p><pre><code>label.<span class="property">numberOfLines</span> = <span class="number">0</span>
label.<span class="property">lineBreakMode</span> = .<span class="dotAccess">byWordWrapping</span>
</code></pre><p>这时候，下面这样的换行方式是不会出现的：</p><pre><code><span class="type">This</span> message could not be
delivered
</code></pre><p>实际上得到的字符串是以下：</p><pre><code><span class="type">This</span> message could not 
be delivered
</code></pre><p>乍一看，多少让人有些摸不着头脑，然而这是一个 Apple 刻意而为之的设计，目的在于避免孤词寡行的出现。参考链接：</p><ul><li><a href="https://stackoverflow.com/questions/46200027/uilabel-wrong-word-wrap-in-ios-11">https://stackoverflow.com/questions/46200027/uilabel-wrong-word-wrap-in-ios-11</a></li></ul><p>个人认为这是一个有趣的设计，然而并没有任何途径可以禁止这种换行方式，这多少会带来一些不便，好在从 iOS 14 开始，终于可以通过设置 <code>lineBreakStrategy</code> 来避免这样的换行。</p><pre><code><span class="keyword">if #available</span>(iOS <span class="number">14.0</span>, *) {
    label.<span class="property">lineBreakStrategy</span> = []
}
</code></pre><hr><h1>05/27</h1><h2>fileSystemRepresentation</h2><p>最近依然在为 ZIPFoundation 做 zip64 的支持，当使用 <code>fopen</code> 打开指定路径的文件时，使用的是类似下述的代码。在 POSIX 系统中直接使用 <code>UTF8String</code> 并不是一个明智的办法，使用 <code>fileSystemRepresentation</code> 先将字符串转换成文件系统的规范形式然后用 <code>UTF-8</code> 编码会比较安全。</p><pre><code><span class="keyword">let</span> representation = <span class="type">FileManager</span>.<span class="property">default</span>.<span class="call">fileSystemRepresentation</span>(withPath: path)
<span class="keyword">let</span> file: <span class="type">UnsafeMutablePointer</span>&lt;<span class="type">FILE</span>&gt; = <span class="call">fopen</span>(representation, <span class="string">"r+b"</span>)
</code></pre><p>参考链接：</p><ol><li><a href="https://objccn.io/issue-9-2/">https://objccn.io/issue-9-2/</a></li><li><a href="https://github.com/ZipArchive/ZipArchive/issues/326">https://github.com/ZipArchive/ZipArchive/issues/326</a><ul><li>这其中提到一个真实发生的案例，在 iOS 10.2 中使用 <code>UTF8String</code> 来创建文件名，很有可能在 iOS 10.3 上无法打开。这其中的原因，大概率在于 10.2 的文件系统是 <code>HFS+</code>，而 10.3 是 <code>APFS</code>。</li></ul></li></ol><hr><h1>05/19</h1><h2>stat - st_size 是什么类型</h2><p>获取文件大小的方式：</p><ol><li>FileAttributeKey</li></ol><pre><code><span class="keyword">let</span> attr = <span class="keyword">try</span> <span class="type">FileManager</span>.<span class="property">default</span>.<span class="call">attributesOfItem</span>(atPath: filePath)
<span class="keyword">let</span> fileSize = attr[<span class="type">FileAttributeKey</span>.<span class="property">size</span>] <span class="keyword">as</span>? <span class="type">UInt64</span>
</code></pre><ol start="2"><li>stat</li></ol><pre><code><span class="keyword">let</span> representation = <span class="type">FileManager</span>.<span class="property">default</span>.<span class="call">fileSystemRepresentation</span>(withPath: filePath)
<span class="keyword">var</span> fileStat = <span class="call">stat</span>()
<span class="call">lstat</span>(representation, &amp;fileStat)
<span class="keyword">let</span> fileSize = fileStat.<span class="property">st_size</span>
</code></pre><ul><li>关于 <code>st_size</code> 的类型，根据 link1，它是 <code>off_t</code>；根据 link2，<code>off_t</code> 是 <code>__darwin_off_t</code> ；根据最后一个 link，可以知道其实是 <code>int64</code> 。必须要注意的是，尽管用于表示 size，它并非一个无符号的数。<ol><li><a href="https://opensource.apple.com/source/xnu/xnu-4570.41.2/bsd/sys/stat.h.auto.html">https://opensource.apple.com/source/xnu/xnu-4570.41.2/bsd/sys/stat.h.auto.html</a></li><li><a href="https://opensource.apple.com/source/xnu/xnu-2422.1.72/bsd/sys/_types/_off_t.h.auto.html">https://opensource.apple.com/source/xnu/xnu-2422.1.72/bsd/sys/<em>types/</em>off_t.h.auto.html</a></li><li><a href="https://opensource.apple.com/source/xnu/xnu-2782.30.5/bsd/sys/_types.h.auto.html">https://opensource.apple.com/source/xnu/xnu-2782.30.5/bsd/sys/_types.h.auto.html</a></li></ol></li></ul><hr><h1>05/14</h1><h2>AVPlayer</h2><p>一篇非常简明的阐述如何使用 <code>AVPlayer</code> 的文章：</p><p><a href="https://medium.com/free-code-camp/how-to-set-up-video-streaming-in-your-app-with-avplayer-7dc21bb82f3">https://medium.com/free-code-camp/how-to-set-up-video-streaming-in-your-app-with-avplayer-7dc21bb82f3</a></p><h2>HLS - HTTP Live Streaming</h2><p>HLS 是一个 Apple 定义的流传输协议，基于 HTTP 实现，我们会发现它的后缀是 <code>.m3u8</code>，也就是用 <code>UTF-8</code> 编码的 Unicode 版本 <code>M3U</code> 。对于视频技术知之甚少的我而言又要问，那 M3U 是什么，根据维基，M3U 文件是一种纯文本文件，可以指定一个或多个多媒体文件的位置。</p><p>关于 HLS 是什么，<code>m3u8</code> 的结构是什么样，文档中的图片非常清晰易懂：<a href="https://developer.apple.com/library/archive/referencelibrary/GettingStarted/AboutHTTPLiveStreaming/about/about.html">https://developer.apple.com/library/archive/referencelibrary/GettingStarted/AboutHTTPLiveStreaming/about/about.html</a></p><p>HLS 拥有高性能，高兼容性，作为代价，切片和查询导致了较高的延迟。2019 年，Apple 介绍了</p><p><a href="[https://developer.apple.com/videos/play/wwdc2019/502/](https://developer.apple.com/videos/play/wwdc2019/502/">ILow-Latency HLS</a>)。</p><hr><h1>05/13</h1><h2>lineHeight and lineSpacing</h2><p>无法通过 <code>UILabel</code> 的属性来直接设置行高，但是可以为 Attributed String 来设置这些值。</p><p>除了 lineSpacing，我们还可以使用 lineHeight 相关的几个属性，例如:</p><pre><code>minimumLineHeight
maximumLineHeight
lineHeightMultiple
</code></pre><p>但事实上 iOS 的行高和 CSS Flexbox 中以及通常认知中的行高并不完全相同。参见下图：</p><p>所以如果需要通常意义上的行高，可以通过设置 baselineOffset 来实现。</p><pre><code><span class="keyword">let</span> paragraphStyle = <span class="type">NSMutableParagraphStyle</span>()
paragraphStyle.<span class="property">lineHeightMultiple</span> = <span class="number">1.6</span>

label.<span class="property">attributedText</span> = <span class="type">NSAttributedString</span>(
    string: <span class="string">"......"</span>,
    attributes: [
        .<span class="dotAccess">baselineOffset</span>: ......,
        .<span class="dotAccess">paragraphStyle</span>: paragraphStyle
    ]
)
</code></pre><hr><h1>05/07</h1><h2>Apple's Compression Algorithms</h2><p>当讨论一个压缩算法的时候，压缩率和速度是最重要的两个维度。</p><p>Apple 自己的压缩框架也提供了多种算法:</p><blockquote><p>WWDC2015 Session 712</p></blockquote><p>Balanced: <code>zlib</code> and <code>lzfse</code> High compression, slow: <code>lzma</code> Low compression, fast: <code>lz4</code></p><hr><h1>05/06</h1><h2>setUp()/tearDown()</h2><ul><li>instance method: each test method</li><li>class method: all test methods</li></ul><h2>globallyUniqueString</h2><p>一般来说提到唯一标志符我们常常会先想到 <code>UUID</code> ，例如用下述方法来生成独一无二的字符串：</p><pre><code><span class="type">UUID</span>().<span class="property">uuidString</span>
</code></pre><p>但如果我们需要创建临时文件，那使用进程级别的唯一字符串也不失为一个好办法。其中包含了主机名，进程 ID，时间戳，来保证其唯一性。</p><pre><code><span class="type">ProcessInfo</span>.<span class="property">processInfo</span>.<span class="property">globallyUniqueString</span>
</code></pre></div></article><div class="giscus mt-20"></div></div></div><footer class="flex flex-col text-sm font-light mt-auto text-zinc-500 dark:text-zinc-400"><p class="text-center mt-16">Copyright © 2014-2022 Ckitakishi</p><p class="text-center mt-1">Powered by <a href="https://github.com/johnsundell/publish" class="link-underline">Publish</a> &amp; <a href="https://github.com/Ckitakishi/PaletteTheme" class="link-underline">Palette</a></p><div class="grid grid-cols-8 w-full h-[8px] mt-6"><div class="bg-[#ab4642]"></div><div class="bg-[#dc9656]"></div><div class="bg-[#f7ca88]"></div><div class="bg-[#a1b56c]"></div><div class="bg-[#86c1b9]"></div><div class="bg-[#7cafc2]"></div><div class="bg-[#ba8baf]"></div><div class="bg-[#a16946]"></div></div></footer></div><script src="https://giscus.app/client.js"
        data-repo="Ckitakishi/Ckitakishi.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNTU4Njk1OQ=="
        data-category="General"
        data-category-id="DIC_kwDOAO3Wj84CBSR7"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script></body></html>